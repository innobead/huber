name: Release

on:
  push:
    tags:
    - 'v*.*.*'

jobs:
  create_release:
    name: Create github release
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.release.outputs.id }}
      release_upload_url: ${{ steps.release.upload_url }}
    steps:
    - uses: actions/checkout@v4

    - name: Build changelog
      id: changelog
      uses: mikepenz/release-changelog-builder-action@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Release
      id: release
      uses: softprops/action-gh-release@v2
      with:
        body: ${{steps.changelog.outputs.changelog}}
        draft: true
        name: ${{ github.ref_name }}
        tag_name: ${{ github.ref_name }}

  release-linux-x86_64:
    name: Release - Linux x86_64
    runs-on: ubuntu-latest
    needs: create_release
    steps:
    - uses: actions/checkout@v4
    - uses: extractions/setup-just@v2
    - uses: dtolnay/rust-toolchain@stable
    - uses: dtolnay/rust-toolchain@nightly

    - run: just setup-dev
    - run: just release
    - uses: softprops/action-gh-release@v2
      if: ${{startsWith(github.ref, 'refs/tags/') }}
      with:
        draft: true
        files: "./.target/*"

  release-linux-aarch64:
    name: Release - Linux aarch64
    runs-on: ubuntu-latest
    needs:
    - create_release
    steps:
    - uses: actions/checkout@v4
    - uses: docker/setup-qemu-action@v3
    - id: buildx
      uses: docker/setup-buildx-action@v3
      with:
        version: latest

    - name: Print available platforms
      run: echo ${{ steps.buildx.outputs.platforms }}

    - name: Setup, Test, Build
      run: just release-multiarch

    - name: Release artifacts
      uses: softprops/action-gh-release@v2
      if: ${{startsWith(github.ref, 'refs/tags/') }}
      with:
        draft: true
        files: "./.target/*"

  release-macos:
    name: Release - MacOS
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        runner: [ macos-latest-large, macos-latest ]
    needs:
    - create_release
    steps:
    - uses: actions/checkout@v4
    - uses: extractions/setup-just@v2
    - uses: dtolnay/rust-toolchain@stable
    - uses: dtolnay/rust-toolchain@nightly

    - run: just setup-dev
    - run: just release

    - name: Release artifacts
      uses: softprops/action-gh-release@v2
      if: ${{startsWith(github.ref, 'refs/tags/') }}
      with:
        draft: true
        files: "./.target/*"

  release-windows:
    name: Release - Windows
    runs-on: windows-latest
    needs:
    - create_release
    steps:
    - uses: actions/checkout@v4
    - uses: extractions/setup-just@v2
    - uses: dtolnay/rust-toolchain@stable
    - uses: dtolnay/rust-toolchain@nightly

    - run: ./hack/windows/setup-dev.ps1
    - run: ./hack/windows/release.ps1

    - name: Release artifacts
      uses: softprops/action-gh-release@v2
      if: ${{startsWith(github.ref, 'refs/tags/') }}
      with:
        draft: true
        files: "./target/release/*.exe*"
